################## metaserver ####################

 message GetMetaDataRequest {
  required uint64 cluster_version = 10;
};

message GetMetaDataResponse {
  required ResponseCode rc = 10;
  optional ClusterInfoPb cluster_info = 20;
  repeated ChunkInfoPb chunk_info = 30;
  repeated PGInfoPb pg_info = 40;
  optional uint64 pc_size = 50;
  repeated string blacklist_hosts = 51;//no need anymore in xstore
  optional uint32 refuse_seconds = 52;//no need anymore in xstore
  repeated BlacklistItem blacklist_items = 53;
};


1. metaserver发送集群路由信息给idun

message PushMetaDataToIdunRequest {
  # required ResponseCode rc = 10;
  
  required uint64 cluster_version = 10;
  optional ClusterInfoPb cluster_info = 20;
  repeated ChunkInfoPb chunk_info = 30;
  repeated PGInfoPb pg_info = 40;
  required uint32 set_id = 50;

  # optional uint64 pc_size = 50;
  # repeated string blacklist_hosts = 51;//no need anymore in xstore
  # optional uint32 refuse_seconds = 52;//no need anymore in xstore
  # repeated BlacklistItem blacklist_items = 53;
};


 message PushMetaDataToIdunResponse {
  required required ResponseCode rc = 10;
};

######################## fryer ###########################

1. fryer向idun注册    fryer login idun 每一块盘都要注册一次

message IdunResourceLoginRequest {
    required string vdisk_id = 1;         // 资源盘id
    //required uint64 vdisk_cap = 2;        // 资源盘容量
    optional uint32 version = 3;          // 资源盘版本号
    required VDiskType vdisk_type = 4;    // 资源盘类型
    required uint32 set_id = 8;           //集群set_id

    required string src_vdisk_id = 5;     // 资源源数据盘id
    optional uint32 src_version = 6;      // 资源源数据版本号
    required VDiskType src_vdisk_type = 7;// 

    optional IdunLCInfo lc_info = 11;     // udisk必填
}

message IdunLCInfo {
    optional string extern_id = 1;
    required uint32 lc_id = 2;
    required uint32 lc_random_id = 3;
    required uint32 lc_size = 4;            // 云盘大小
    //required uint64 pc_size = 5;            // 分片大小
    //required uint64 cluster_version = 6;    // 集群版本号
    repeated IdunPcRoute pc_routes = 7;     // 查询时填写
}

message IdunPcRoute {
    required uint32 pc_no = 1;              // 分片序号
    required uint32 pg_id = 2;
    required uint32 chunk_id = 3;           // idun只取chunk_id
    optional string chunk_ip = 4;
    optional uint32 chunk_port = 5;
}

fryer ping hela最后一个pc clone完后发起logout 流程
2. fryer向idun logout 

message IdunResourceLogoutRequest {
    required string vdisk_id = 1;
    optional uint32 version = 2;
    required VDiskType vdisk_type = 3;
    required uint32 set_id = 4;           //集群set_id
    required uint32 lease_time = 5;   //fryer端租约过期时间 应该大于idun 端实际的租约时间
}

message IdunResourceLogoutResponse {
    required ResponseCode rc = 10;
}

3. fryer logout流程
  3.1. idun_resource_finish_request  fryer向idun发起clone完成的消息

   message IdunResourceFinishRequest {
    required string vdisk_id = 1;
    required uint32 version = 2;
    required VDiskType vdisk_type = 3;
    required uint32 set_id = 4;
}
   
   message IdunResourceFinishResponse {
    required ResponseCode rc = 10;
}

3.2. fryer向idun发起资源结束的消息，这时候idun就停止将该盘作为源  IdunResourceExpiredRequest
fryer向hela发起logout 

idun收到fryer的logout 将立即停止将 该盘作为源提供给其他盘进行clone

message IdunResourceExpiredRequest {
    required string vdisk_id = 1;
    required uint32 version = 2;
    required VDiskType vdisk_type = 3;
    required uint32 set_id = 4;
}

message IdunResourceExpiredResponse {
    required ResponseCode rc = 10;
}

3.3.1   idun_resource_logout_request  删除相关源信息

message IdunResourceLogoutRequest {
    required string vdisk_id = 1;
    optional uint32 version = 2;
    required VDiskType vdisk_type = 3;
    required uint32 set_id = 4;
}

message IdunResourceLogoutResponse {
    required ResponseCode rc = 10;
}

3.3.2 fryer 向hela发起过期本地源请求，并且等待本地源引用结束

message HelaTaskLogoutRequest {
    required string chrono_id = 1;
}

message HelaTaskLogoutResponse {
    required ResponseCode rc = 1;
    required string chrono_id = 2;
}

3.4  更改数据库的状态

3.5.1 向 ark logout 通知clone完成

message ChronoCloneLogoutPbRequest {
    required string chrono_id = 10;
}

message ChronoCloneLogoutPbResponse {
    required ResponseCode rc = 10;
    required string chrono_id = 20;
}

3.5.2 更新盘的状态

// 更新数据库中的lc信息。
// 需要更新哪一项就填充哪一项，除了必填项和数据库中没有的对应项。
// 不能用来更新 id, extern_id, lc_random_id, size. 
message MetaUpdateUDiskRequest {
  required LCInfoPb lc = 10;
  optional bool multi_attach = 11;
};

message MetaUpdateUDiskResponse {
  required ResponseCode rc = 10;  
};

3.5.3 更新db里chonoid后clone完成

########################### hela #############################

1. hela 向 idun 更新源信息

message IdunUpdateResourceRequest {
    required string vdisk_id = 1;
    optional uint32 version = 3;
    required VDiskType vdisk_type = 4;
    required uint32 set_id = 8;                    // 该盘的set_id
    repeated IdunPcRoute pc_routes = 11;          // udisk必填
}

message IdunPcRoute {
    required uint32 pc_no = 1;              // 分片序号
    required uint32 pg_id = 2;
    required uint32 chunk_id = 3;           // idun只取chunk_id
    optional string chunk_ip = 4;
    optional uint32 chunk_port = 5;
}

idun的作为源的盘信息里可以有一个lease_time表示最近发放租约的开始时间

回应给hela

message IdunUpdateResourceResponse {
    required ResponseCode rc = 10;
}


2. hela 向idun查源

message IdunQueryResourceRequest {
    required string src_vdisk_id = 1;
    optional uint32 src_version = 2;
    required VDiskType src_vdisk_type = 3;    // 数据源 盘类型
    required VDiskType vdisk_type = 4;        // 目标 盘类型
    required time_t req_send_time = 5;
    repeated uint32 pc_nos = 11;              // udisk必填  pc_number可以有多个，批量查源     repeated
}


2. idun 将源信息回应给hela

idun作为源的盘信息里可以有一个lease_time表示最近发放租约的开始时间


批量pc查源时可能部分pc是  在同一个盘id上面的， 或者部分pc是  在不同盘id上面的

message IdunQueryResourceResponse {
    required ResponseCode rc = 10;
    //required VDiskType vdisk_type = 20;
    // required uint32 idun_lease_time =30;    // fryer的租约时间要比idun长，fryer等待租约时间后才logout ，fryer logout的时候可以带lease_time
    repeated IdunLCInfo lc_infos = 30;  // udisk   repeated 多个   部分pc是  在不同盘id上面的 所以这里需要 使用repeated 多个
}

message IdunLCInfo {   //不需要盘的set id
    optional string extern_id = 1;    // 已经clone完成后作为源的盘
    required uint32 lc_id = 2;
    required uint32 lc_random_id = 3;
    required uint32 lc_size = 4;            // 云盘大小
    //required uint64 pc_size = 5;            // 分片大小
    //required uint64 cluster_version = 6;    // 集群版本号
    repeated IdunPcRoute pc_routes = 7;     // 查询时填写     在同一个盘id上面的 所以这里需要 使用repeated 多个
    required time_t req_send_time = 8;
    required time_t req_get_time = 9;
    required time_t res_send_time = 10;
    required time_t lease_start_time = 11;  // 返回给hela 租约开始时间  hela自己计算租约时间长度

}

message IdunPcRoute {
    required uint32 pc_no = 1;              // 分片序号
    required uint32 pg_id = 2;
    
    required uint32 chunk_id = 3;           // idun只取chunk_id
    optional string chunk_ip = 4;
    optional uint32 chunk_port = 5;

}

required time_t lease_start_time = 6;  // hela获取到idun的pc分片源信息后存放租约开始时间 lease_start_time   然后再计算可以租约的时间 存放到hela管理pc源的结构里面


# hela 管理本地源信息




########################### idun #############################
                                                 idun logout  hela logout hela_task_logout_request
                                                 这里logout 完所有的hela
hela_clone_done.cc --> hela_clone_expired.cc --> hela_clone_logout.cc --> hela_clone_finish.cc --> hela_clone_end.cc

